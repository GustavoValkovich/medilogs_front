<div class="consultation-root">
  <mat-card class="consultation-card">
  <div class="consultation-header">
    <h4 class="consultation-subtitle">Nueva consulta para:</h4>
    <h3 class="consultation-patient-name">{{ patientName || '' }}</h3>
  </div>
  <form [formGroup]="form" (ngSubmit)="submit()">
      <mat-form-field appearance="fill" class="full"><mat-label>Motivo</mat-label><input matInput formControlName="motivo"></mat-form-field>

      <div class="form-actions">
        <button mat-flat-button color="primary" type="submit">Guardar Consultas</button>
        <button mat-button type="button" (click)="router.navigate(['/patients'])">Cancelar</button>
      </div>
    </form>
  </mat-card>

  <mat-card class="history-card">
    <h3>Consultas Cl√≠nicas Guardadas</h3>

    <div *ngIf="consultasData?.data?.length; else noHist">

      <table mat-table [dataSource]="consultasData.data" class="mat-elevation-z2" style="width:100%">

        <ng-container matColumnDef="created_at">
          <th mat-header-cell *matHeaderCellDef>Fecha / Hora</th>
          <td mat-cell *matCellDef="let h">{{ h.created_at ? (h.created_at | date:'dd/MM/yyyy HH:mm') : '-' }}</td>
        </ng-container>

        <ng-container matColumnDef="motivo">
          <th mat-header-cell *matHeaderCellDef>Motivo</th>
          <td mat-cell *matCellDef="let h">{{ truncateText(h.medical_record || h.reason || h.motivo, 30) }}</td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let h">
              <button mat-icon-button color="warn" aria-label="Eliminar" (click)="$event.stopPropagation(); deleteConsultation(h)">
                <mat-icon>delete</mat-icon>
              </button>
            </td>
        </ng-container>

  <tr mat-header-row *matHeaderRowDef="displayedColumnsHist"></tr>
  <tr mat-row *matRowDef="let row; columns: displayedColumnsHist" (click)="openConsultationDetail(row)" class="clickable-row"></tr>
      </table>

      <mat-paginator [pageSizeOptions]="[5,10]" showFirstLastButtons></mat-paginator>
    </div>

    <ng-template #noHist>
      <p>No hay consultas guardadas para este paciente.</p>
    </ng-template>

    <div class="back-actions">
      <button mat-flat-button color="primary" (click)="router.navigate(['/patients'])">Volver a Pacientes</button>
    </div>

  </mat-card>
</div>
